<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>User Research Agent · Conversion OS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    :root {
      --blue-main: #2f6bff;
      --blue-soft: #eaf0ff;
      --silver: #f4f6f8;
      --silver-border: #d9dee5;
      --text-main: #1f2937;
      --text-sub: #6b7280;
      --wave: rgba(47,107,255,0.08);
      --ok: #0ea5e9;
      --warn: #f59e0b;
      --bad: #ef4444;
    }
    * { box-sizing: border-box; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB"; }
    body {
      margin: 0; padding: 0;
      background:
        radial-gradient(circle at 20% 0%, var(--wave), transparent 40%),
        radial-gradient(circle at 80% 20%, var(--wave), transparent 45%),
        #ffffff;
      color: var(--text-main);
    }
    header { padding: 28px 40px 18px; border-bottom: 1px solid var(--silver-border); }
    header h1 { margin: 0; font-size: 26px; color: var(--blue-main); }
    header p { margin-top: 6px; color: var(--text-sub); font-size: 14px; }
    main { padding: 24px 40px 60px; }
    .grid { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 24px; }
    .card {
      background: var(--silver);
      border: 1px solid var(--silver-border);
      border-radius: 14px;
      padding: 18px 20px;
    }
    .card h2 { margin: 0 0 12px; font-size: 18px; color: var(--blue-main); }
    label { display:block; font-size: 13px; margin-top: 12px; margin-bottom: 6px; color: var(--text-sub); }
    select, textarea, input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--silver-border);
      font-size: 14px;
      background: #fff;
    }
    textarea { min-height: 78px; resize: vertical; }
    .row { display:flex; gap: 12px; }
    .row > div { flex: 1; }
    .tabs { display:flex; gap: 10px; margin-bottom: 14px; }
    .tab {
      border: 1px solid var(--silver-border);
      background: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      color: var(--text-sub);
      user-select: none;
    }
    .tab.active { border-color: var(--blue-main); color: var(--blue-main); background: var(--blue-soft); }
    .btn {
      margin-top: 16px;
      padding: 12px 18px;
      border-radius: 12px;
      border: none;
      background: var(--blue-main);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .btn.secondary { background: #111827; }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }
    .output {
      background: #fff;
      border: 1px dashed var(--silver-border);
      border-radius: 12px;
      padding: 14px;
      font-size: 13px;
      line-height: 1.65;
      white-space: pre-wrap;
      min-height: 420px;
    }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background: var(--blue-soft); color: var(--blue-main); font-size: 12px; margin-right: 6px; }
    .hint { color: var(--text-sub); font-size: 12px; margin-top: 8px; }
    .small { font-size: 12px; color: var(--text-sub); }
    footer { padding: 22px 40px; border-top: 1px solid var(--silver-border); color: var(--text-sub); font-size: 13px; }
    a { color: var(--blue-main); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Tab C */
    .tab-c-only { display: none; }
    .tab-c-only.visible { display: block; }
    .tab-c-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .graph-container {
      height: 420px;
      background: #fff;
      border: 1px solid var(--silver-border);
      border-radius: 12px;
      overflow: hidden;
    }
    .proof-block {
      background: #fff;
      border: 1px solid var(--silver-border);
      border-radius: 12px;
      padding: 14px;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      margin-top: 12px;
    }
    .proof-block .line { margin-bottom: 8px; }
    .proof-block .hint-text { color: var(--text-sub); font-size: 12px; margin-top: 10px; }
    .node-detail {
      background: #fff;
      border: 1px dashed var(--silver-border);
      border-radius: 10px;
      padding: 12px;
      font-size: 12px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 180px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .btn-sm { margin-top: 8px; margin-right: 8px; padding: 8px 14px; font-size: 13px; }
    .err-msg { color: var(--bad); font-size: 13px; padding: 12px; }
  </style>
</head>
<body>
<header>
  <h1>User Research Agent · Conversion OS</h1>
  <p>先做B端售前诊断 → 自动路由研究方案 → 输出可直接提升首单/复购转化的"资产+验证口径"（不依赖爬虫）</p>
</header>

<main>
  <div class="tabs">
    <div class="tab active" id="tabA" onclick="switchTab('A')">A. B端客户诊断（售前/立项）</div>
    <div class="tab" id="tabB" onclick="switchTab('B')">B. 用户研究交付（定性+定量）</div>
    <div class="tab" id="tabC" onclick="switchTab('C')">C. Decision Memory 可视化（Trace Graph）</div>
  </div>

  <!-- Tab A / B -->
  <div id="panelAB" class="grid">
    <section class="card">
      <h2 id="formTitle">输入（给Agent）</h2>

      <div class="row">
        <div>
          <label>行业</label>
          <input id="industry" placeholder="例如：美妆护肤 / 营养保健品 / 耐消 / 软件SaaS"/>
        </div>
        <div>
          <label>目标市场</label>
          <input id="market" placeholder="例如：北美 / 欧洲 / 东南亚 / 国内"/>
        </div>
      </div>

      <label>公司阶段</label>
      <select id="stage">
        <option>0-1（基建/做Demo，尽快验证可行性）</option>
        <option>1-10（已出Demo/早期产品，快速找客户验证商业闭环）</option>
        <option>10-100（已跑通交易/收入，需规模化增长与效率提升）</option>
        <option>成熟期（交易规模/利润稳定，追求更高效率或新增长点）</option>
        <option>探索创新（成熟业务之外的新业务孵化/战略布局）</option>
      </select>

      <label>增长驱动方式（可多选，按主次排序）</label>
      <textarea id="growth" placeholder="例如：营销驱动增长（Marketing-Led Growth, MLG）\n产品驱动增长（Product-Led Growth, PLG）"></textarea>
      <div class="hint">提示：不要只写缩写。请用中文意思（括号里写英文全称）。</div>

      <label>本次服务的业务定位（在公司内部属于什么）</label>
      <select id="positioning">
        <option>新孵化/新业务：方向未完全清晰，需要探索用户与场景</option>
        <option>旧业务新增长：服务于老业务增长，但新方式效果不确定</option>
        <option>旧供给找新用户：供给相对成熟，需要找到新目标人群与新表达</option>
        <option>已验证价值：已有明确需求/供给匹配，需要规模化复制与扩张（做了大概率有效）</option>
        <option>新供给/新交易场：为一类用户新需求构建新的交易场/新产品线</option>
      </select>

      <label>本次目标</label>
      <select id="goal">
        <option>提升首单购买转化率</option>
        <option>提升复购转化率</option>
        <option>降低退款/退货率</option>
        <option>提升线索→成交转化率</option>
      </select>

      <label>核心问题（尽量包含事实/数据/典型案例）</label>
      <textarea id="problem" placeholder="例如：买量成本上升，点击不差但加购率低；用户经常说‘看不懂差别/不敢买’，弃购率高。"></textarea>

      <label>约束（可选）</label>
      <textarea id="constraints" placeholder="例如：两周内要出结果；不能触达未成年人；不能存储原始音频；预算中等。"></textarea>

      <button class="btn" onclick="runA()">运行 A：诊断 → 研究方案</button>
      <button class="btn secondary" onclick="runB()" id="runBBtn" disabled>运行 B：生成访谈大纲 + 问卷草案</button>

      <div class="hint">
        模板下载：
        <a href="../templates/B端客户售前诊断问卷_旗舰版.docx" download>Word问卷模板</a> ·
        <a href="../templates/研究策略路由表_旗舰版.xlsx" download>Excel路由表</a>
      </div>

      <div class="small" style="margin-top:10px;">
        后端默认地址：<span id="apiBaseShow">http://127.0.0.1:8000</span>
        · 如果你改了端口，点这里：
        <a href="#" onclick="setApiBase(); return false;">设置API地址</a>
      </div>
    </section>

    <section class="card">
      <h2>输出（可执行交付物）</h2>
      <div class="output" id="out">等待输入…</div>
      <div style="margin-top:12px;">
        <span class="pill">证据链优先</span>
        <span class="pill">可行动 + 可验证</span>
        <span class="pill">只读查询模板</span>
      </div>
    </section>
  </div>

  <!-- Tab C: Decision Memory -->
  <div id="panelC" class="tab-c-only">
    <div class="tab-c-grid">
      <section class="card">
        <h2>输入 / 操作</h2>
        <label>topic（可选）</label>
        <input id="traceTopic" placeholder="例如：fintech"/>
        <label>stage（可选）</label>
        <input id="traceStage" placeholder="例如：1-10"/>
        <button class="btn btn-sm" onclick="loadTraceGraph()">加载 Trace Graph</button>
        <button class="btn btn-sm secondary" onclick="loadDecisionsSnapshots()">加载最新 Decisions/Snapshots</button>
        <button class="btn btn-sm secondary" onclick="openApiDocs()">打开 API Docs</button>
        <div class="hint" style="margin-top:12px;">
          Trace Graph 需 Decision Memory 后端（uvicorn backend.api.main:app）。API 需 X-API-Key: admin123。
        </div>
      </section>

      <section class="card">
        <h2>Trace Graph 与 Memory Proof</h2>
        <div id="graphError" class="err-msg" style="display:none;"></div>
        <div id="graphWrapper" class="graph-container" style="display:none;"></div>
        <div id="graphPlaceholder" class="output" style="min-height:200px;">
          点击「加载 Trace Graph」获取 nodes/edges 并渲染图谱。
        </div>
        <div id="nodeDetail" class="node-detail" style="display:none;"></div>
        <div class="proof-block" style="margin-top:14px;">
          <div class="line"><strong>RecallHits Found:</strong> <span id="proofRecall">—</span></div>
          <div class="line"><strong>Conflict Reason:</strong> <span id="proofConflict">—</span></div>
          <div class="line"><strong>Final Decision Rationale:</strong> <span id="proofRationale">—</span></div>
          <div class="hint-text">若 API 无法推导，请从 demo_outputs/demo.log 复制上述三行填入展示。</div>
        </div>
      </section>
    </div>
  </div>
</main>

<footer>
  <div class="pill">A段：售前诊断</div>
  <div class="pill">B段：研究交付</div>
  <div class="pill">C段：Decision Memory</div>
  <p style="margin-top:10px;">
    本Demo用于展示"用户研究如何被Agent化并服务转化提升闭环"，不依赖外部平台抓取数据。
  </p>
</footer>

<script>
  let CURRENT_DIAGNOSE = null;
  let TAB = 'A';
  let API_BASE = localStorage.getItem("API_BASE") || "http://127.0.0.1:8000";
  const API_KEY = "admin123";
  document.getElementById("apiBaseShow").innerText = API_BASE;

  let visNetworkInstance = null;
  let lastTraceGraphData = null;

  function switchTab(t){
    TAB = t;
    document.getElementById("tabA").classList.toggle("active", t==='A');
    document.getElementById("tabB").classList.toggle("active", t==='B');
    document.getElementById("tabC").classList.toggle("active", t==='C');
    document.getElementById("panelAB").style.display = (t==='A' || t==='B') ? 'grid' : 'none';
    document.getElementById("panelC").classList.toggle("visible", t==='C');
    document.getElementById("formTitle").innerText = (t==='A') ? "输入（给Agent）" : (t==='B') ? "输入（沿用A段信息）" : "";
  }

  function setApiBase(){
    const v = prompt("请输入后端API地址（例如 http://127.0.0.1:8000 ）", API_BASE);
    if(!v) return;
    API_BASE = v.replace(/\/+$/,'');
    localStorage.setItem("API_BASE", API_BASE);
    document.getElementById("apiBaseShow").innerText = API_BASE;
  }

  function readInput(){
    const growthText = document.getElementById('growth').value || "";
    const growthList = growthText.split("\n").map(x=>x.trim()).filter(Boolean);

    return {
      industry: document.getElementById('industry').value || "未填写",
      market: document.getElementById('market').value || "未填写",
      company_stage: document.getElementById('stage').value,
      growth_driver: growthList.length ? growthList : ["营销驱动增长（Marketing-Led Growth, MLG）"],
      biz_positioning: document.getElementById('positioning').value,
      core_problem: document.getElementById('problem').value,
      constraints: document.getElementById('constraints').value,
      target_goal: document.getElementById('goal').value
    };
  }

  async function post(path, body){
    const res = await fetch(`${API_BASE}${path}`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(`HTTP ${res.status}: ${t}`);
    }
    return await res.json();
  }

  function pretty(obj){
    return JSON.stringify(obj, null, 2);
  }

  async function runA(){
    const payload = readInput();
    const out = document.getElementById('out');
    out.innerText = "运行中…";
    try{
      const diag = await post("/api/diagnose", payload);
      CURRENT_DIAGNOSE = diag;
      const plan = await post("/api/research_plan", { diagnose: diag, timeline: "2-4周", budget_level: "中" });

      let txt = "";
      txt += "【A段：售前诊断结果】\n";
      txt += `- 公司阶段：${diag.stage}\n`;
      txt += `- 增长驱动：${(diag.growth_driver||[]).join(" / ")}\n`;
      txt += `- 业务定位：${diag.biz_positioning}\n`;
      txt += `- 目标：${diag.goal}\n`;
      txt += `- 问题类型：${(diag.problem_types||[]).join(" / ")}\n`;
      txt += `- 紧急度：${diag.urgency}；可控性：${diag.controllability}\n\n`;

      txt += "【推荐路线】\n";
      (diag.recommended_route||[]).forEach(x=>{ txt += `- ${x}\n`; });
      txt += "\n【研究方案（摘要）】\n";
      txt += `- 定性样本建议：${plan.qualitative.recommended_n}\n`;
      txt += `- 定量样本建议：${plan.quantitative.recommended_n}\n`;
      txt += `- 交付物重点：\n`;
      (plan.deliverables||[]).forEach(x=>{ txt += `  · ${x}\n`; });

      txt += "\n【验证指标口径（示例）】\n";
      (plan.validation_metrics||[]).forEach(m=>{
        txt += `- ${m.metric}：${m.definition}${m.note?("（"+m.note+"）"):""}\n`;
      });

      txt += "\n【下一步】\n";
      txt += "- 点“运行B”生成：售前提问清单、45分钟访谈大纲、定量问卷草案与数据质量规则。\n";

      out.innerText = txt;
      document.getElementById("runBBtn").disabled = false;
      switchTab('A');
    }catch(e){
      out.innerText = "出错：\n" + e.message + "\n\n请确认：后端已启动（python backend/app.py），且API地址正确。";
      document.getElementById("runBBtn").disabled = true;
    }
  }

  async function runB(){
    if(!CURRENT_DIAGNOSE){
      alert("请先运行A段。");
      return;
    }
    const payload = readInput();
    const out = document.getElementById('out');
    out.innerText = "生成B段产物中…";
    try{
      const b2b = await post("/api/b2b_questions", payload);
      const qual = await post("/api/qual_guide", payload);
      const quant = await post("/api/quant_survey", payload);

      let txt = "";
      txt += "【B段：可直接交付的研究资产（草案）】\n\n";

      txt += "1) 售前提问清单（给销售/售前）\n";
      (b2b.questions||[]).forEach((q,idx)=>{
        txt += `- [${q.section}] ${q.q}\n`;
      });

      txt += "\n2) 45分钟定性访谈大纲（半结构化）\n";
      txt += `- 时长：${qual.qual_guide.duration_minutes}分钟\n`;
      txt += "- 原则：\n";
      (qual.qual_guide.principles||[]).forEach(p=> txt += `  · ${p}\n`);
      txt += "\n- 结构：\n";
      (qual.qual_guide.sections||[]).forEach(sec=>{
        txt += `  · ${sec.t}\n`;
        (sec.prompts||[]).forEach(p=> txt += `     - ${p}\n`);
      });

      txt += "\n3) 定量问卷草案（模块化，可直接落到问卷系统）\n";
      (quant.quant_survey.modules||[]).forEach(mod=>{
        txt += `- 模块：${mod.name}\n`;
        if(mod.note) txt += `  说明：${mod.note}\n`;
        (mod.questions||[]).forEach(q=>{
          txt += `  · ${q.id}（${q.type}）${q.q}\n`;
        });
      });

      txt += "\n4) 数据质量与清洗规则（自动化）\n";
      const dq = quant.quant_survey.data_quality || {};
      txt += `- 速度异常规则：${dq.speeding_rule || "—"}\n`;
      txt += `- 直线作答规则：${dq.straightlining_rule || "—"}\n`;
      txt += `- 矛盾检测规则：${dq.contradiction_rule || "—"}\n`;
      (dq.attention_checks||[]).forEach(x=> txt += `- 注意力题：${x}\n`);

      txt += "\n5) 只读数据查询模板（Text2SQL的受控替代）\n";
      const sql = await fetch(`${API_BASE}/api/sql_templates`).then(r=>r.json());
      (sql.templates||[]).forEach(t=>{
        txt += `- ${t.name}：${t.description}\n`;
      });

      out.innerText = txt;
      switchTab('B');
    }catch(e){
      out.innerText = "出错：\n" + e.message;
    }
  }

  // ---------- Tab C: Decision Memory ----------
  function getTraceGraphUrl(){
    const topic = (document.getElementById('traceTopic').value || '').trim();
    const stage = (document.getElementById('traceStage').value || '').trim();
    let url = `${API_BASE}/api/v1/trace_graph`;
    const params = [];
    if(topic) params.push('topic='+encodeURIComponent(topic));
    if(stage) params.push('stage='+encodeURIComponent(stage));
    if(params.length) url += '?' + params.join('&');
    return url;
  }

  async function loadTraceGraph(){
    const errEl = document.getElementById('graphError');
    const wrapper = document.getElementById('graphWrapper');
    const placeholder = document.getElementById('graphPlaceholder');
    errEl.style.display = 'none';
    errEl.textContent = '';
    placeholder.style.display = 'block';
    wrapper.style.display = 'none';
    placeholder.innerText = '加载中…';

    try {
      const url = getTraceGraphUrl();
      const res = await fetch(url, {
        headers: { "X-API-Key": API_KEY }
      });
      if(!res.ok){
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text || res.statusText}`);
      }
      const data = await res.json();
      lastTraceGraphData = data;
      renderGraph(data);
      updateProofFromGraph(data);
      placeholder.style.display = 'none';
      wrapper.style.display = 'block';
    } catch(e) {
      placeholder.style.display = 'block';
      placeholder.innerText = '';
      errEl.style.display = 'block';
      errEl.textContent = '加载失败：' + e.message + '\n\n请检查：1) 后端是否启动（uvicorn backend.api.main:app --port 8000）；2) API_BASE 是否正确；3) /api/v1/trace_graph 是否存在。';
    }
  }

  function nodeColorByType(type){
    const map = {
      Evidence:   { background: '#eaf0ff', border: '#2f6bff' },
      Decision:  { background: '#c7d7fe', border: '#1d4ed8' },
      Requirement: { background: '#93c5fd', border: '#1e40af' },
      Outcome:   { background: '#d1d5db', border: '#6b7280' }
    };
    return map[type] || { background: '#f3f4f6', border: '#9ca3af' };
  }

  function nodeShapeByType(type){
    if(type === 'Evidence') return 'box';
    if(type === 'Decision') return 'diamond';
    if(type === 'Requirement') return 'ellipse';
    if(type === 'Outcome') return 'triangle';
    return 'ellipse';
  }

  function edgeLabelByType(type){
    const map = { cites: 'cites', derived_from: 'derived_from', falsifies: 'falsifies', supports: 'supports', updates: 'updates' };
    return map[type] || 'cites';
  }

  function renderGraph(data){
    const wrapper = document.getElementById('graphWrapper');
    wrapper.innerHTML = '';
    const container = document.createElement('div');
    container.style.width = '100%';
    container.style.height = '100%';
    wrapper.appendChild(container);

    const nodes = (data.nodes || []).map(n => {
      const c = nodeColorByType(n.label || n.type);
      const shape = nodeShapeByType(n.label || n.type);
      const label = (n.summary || n.label || n.id || '').substring(0, 40) + ((n.summary||'').length > 40 ? '…' : '');
      return {
        id: n.id,
        label: label,
        shape: shape,
        color: { background: c.background, border: c.border },
        title: n.summary || n.label || n.id,
        raw: n
      };
    });

    const edges = (data.edges || []).map(e => ({
      from: e.source,
      to: e.target,
      label: edgeLabelByType(e.type || 'cites'),
      arrows: 'to'
    }));

    const visNodes = new vis.DataSet(nodes.map(n => ({ id: n.id, label: n.label, shape: n.shape, color: n.color, title: n.title })));
    const visEdges = new vis.DataSet(edges);
    const visData = { nodes: visNodes, edges: visEdges };

    const options = {
      nodes: { font: { size: 12 } },
      edges: { font: { size: 10, align: 'middle' } },
      physics: { enabled: true, barnesHut: { gravitationalConstant: -2000, springLength: 120 } }
    };

    const network = new vis.Network(container, visData, options);
    visNetworkInstance = network;

    const nodeMap = {};
    nodes.forEach(n => { nodeMap[n.id] = n; });

    network.on('click', function(params) {
      if (params.nodes.length === 0) {
        document.getElementById('nodeDetail').style.display = 'none';
        return;
      }
      const id = params.nodes[0];
      const node = nodeMap[id] || (data.nodes || []).find(n => n.id === id);
      const raw = node && node.raw ? node.raw : (data.nodes || []).find(n => n.id === id) || { id };
      renderNodeDetails(raw);
    });
  }

  function renderNodeDetails(node){
    const el = document.getElementById('nodeDetail');
    el.style.display = 'block';
    el.textContent = pretty(node);
  }

  function updateProofFromGraph(data){
    const nodes = data.nodes || [];
    const edges = data.edges || [];
    const decisionCount = nodes.filter(n => (n.label || n.type) === 'Decision').length;
    document.getElementById('proofRecall').textContent = decisionCount > 0
      ? `${decisionCount} cells (includes FALSIFIED:true)`
      : '—（需从 demo.log 复制）';
    document.getElementById('proofConflict').textContent = 'Detected contradiction with Round 2 Falsification (Decision ID: …) — 需从 demo.log 复制';
    document.getElementById('proofRationale').textContent = 'Conflict Detected: Rejected reverting to speed-focus; maintained quality-focus due to previous falsification. — 需从 demo.log 复制';
  }

  async function loadDecisionsSnapshots(){
    try {
      const [decRes, snapRes] = await Promise.all([
        fetch(`${API_BASE}/api/v1/evidence/search`, { headers: { "X-API-Key": API_KEY } }).then(r => r.ok ? r.json() : null).catch(() => null),
        fetch(`${API_BASE}/api/v1/traces`, { headers: { "X-API-Key": API_KEY } }).then(r => r.ok ? r.json() : null).catch(() => null)
      ]);
      if (decRes || snapRes) {
        alert('Decisions/Traces 已加载（见控制台）。当前无独立 Decisions/Snapshots 展示端点，可查看 trace_graph。');
        if (decRes) console.log('Evidence search:', decRes);
        if (snapRes) console.log('Traces:', snapRes);
      } else {
        alert('后端暂无 /api/v1/evidence/search 或 /api/v1/traces 端点，或返回非 200。请先加载 Trace Graph。');
      }
    } catch(e) {
      alert('加载失败：' + e.message);
    }
  }

  function openApiDocs(){
    window.open(`${API_BASE}/docs`, '_blank');
  }
</script>
</body>
</html>
